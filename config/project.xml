<?xml version="1.0" encoding="UTF-8"?>
<project name="" basedir="." default="...">




    <!-- ==================================== -->
    <!--              Properties              -->
    <!-- ==================================== -->




    <property name="build.environment" value="default" />
    <property name="build.public_dir" value="${build.path}/public" />
    <property name="build.log_dir" value="${build.path}/storage/logs" />
    <property name="db.data_path" value="${build.path}/storage/database" />




    <!-- ==================================== -->
    <!--             Dependencies             -->
    <!-- ==================================== -->




    <import file="${phingy.path}/scripts/core/database.xml" />




    <!-- ==================================== -->
    <!--                Tasks                 -->
    <!-- ==================================== -->




    <target name="project:config" depends="build:config, db:config" hidden="true">
        <echo msg="Running project:config" />

        <if>
            <not>
                <isset property="app.debug" />
            </not>
            <then>
                <propertyPrompt
                    propertyName="app.debug"
                    defaultValue=""
                    promptText="Enable debug? (1,0)"
                    useExistingValue="true"
                />

                <phingcall target="build:save_config" />
            </then>
        </if>
    </target>


    <target name="project:build:before" hidden="true">
        <echo msg="Running project:build:before" />
    </target>


    <target name="project:build:after" hidden="true">
        <echo msg="Running project:build:after" />
        <phingcall target="wordpress:permissions" />
        <phingcall target="wordpress:generatesalts" />
        <phingcall target="project:assets:compile:css" />
        <phingcall target="project:assets:compile:javascript" />
    </target>


    <target name="project:build:housekeeping" hidden="true">
        <echo msg="Running project:build:housekeeping" />
    </target>


    <!--
        Set WordPress permissions.
    -->

    <target name="wordpress:permissions" depends="project:config" hidden="true">
        <echo msg="Setup permissions for WordPress..." />
        <mkdir dir="${build.public_dir}/app/uploads" />
        <chmod file="${build.public_dir}/app/uploads" mode="0775" failonerror="false" />
        <echo msg="...done" />
    </target>


    <!--
        Install a new WordPress site.
    -->

    <target name="wordpress:install" depends="project:config, db:create" description="Install a new WordPress site">
        <echo msg="Installing WordPress..." />

        <input propertyname="wordpress.site_title" defaultValue="My WordPress Site">WordPress site title?</input>
        <input propertyname="wordpress.admin_user" defaultValue="">Admin username?</input>
        <input propertyname="wordpress.admin_pass" defaultValue="">Admin password?</input>
        <input propertyname="wordpress.admin_email" defaultValue="">Admin email (must be wrapped in single quotes)?</input>

        <exec command="bin/wp core install --url='&quot;&quot;' --title='${wordpress.site_title}' --admin_user='${wordpress.admin_user}' --admin_password='${wordpress.admin_pass}' --admin_email='${wordpress.admin_email}'" passthru="true" />
        <exec command="bin/wp theme activate starter" passthru="true" />
        <exec command="bin/wp rewrite structure &quot;/%postname%/&quot;" passthru="true" />

        <echo msg="...installation complete. Access your site at http://${build.url}/" />
    </target>


    <!--
        Generate fresh WordPress salts.
    -->

    <target name="wordpress:generatesalts" depends="project:config" description="Generate fresh WordPress salts">
        <delete file="${build.path}/.env.salts" quiet="true" />
        <touch file="${build.path}/.env.salts" />

        <phingy:assets:wordpress:addsalt path="${build.path}/.env.salts" name="AUTH_KEY" />
        <phingy:assets:wordpress:addsalt path="${build.path}/.env.salts" name="SECURE_AUTH_KEY" />
        <phingy:assets:wordpress:addsalt path="${build.path}/.env.salts" name="LOGGED_IN_KEY" />
        <phingy:assets:wordpress:addsalt path="${build.path}/.env.salts" name="NONCE_KEY" />
        <phingy:assets:wordpress:addsalt path="${build.path}/.env.salts" name="AUTH_SALT" />
        <phingy:assets:wordpress:addsalt path="${build.path}/.env.salts" name="SECURE_AUTH_SALT" />
        <phingy:assets:wordpress:addsalt path="${build.path}/.env.salts" name="LOGGED_IN_SALT" />
        <phingy:assets:wordpress:addsalt path="${build.path}/.env.salts" name="NONCE_SALT" />
    </target>


    <!--
        Compile site SASS to CSS.
    -->

    <target name="project:assets:compile:css" depends="project:config" description="Compile site SASS to CSS">
        <phingy:assets:sass:update
            in="${build.public_dir}/app/themes/starter/assets/sass/build.scss"
            out="${build.public_dir}/app/themes/starter/assets/css/compiled.css"
            loadPaths="${build.path}/node_modules/bootstrap-sass/assets/stylesheets"
            bundler="true" />
    </target>


    <!--
        Watch site SASS for changes.
    -->

    <target name="project:assets:watch:css" depends="project:config" description="Watch site SASS for changes">
        <phingy:assets:sass:watch
            watch="${build.public_dir}/app/themes/starter/assets/sass/build.scss"
            out="${build.public_dir}/app/themes/starter/assets/css/compiled.css"
            loadPaths="${build.path}/node_modules/bootstrap-sass/assets/stylesheets"
            bundler="true" />
    </target>


    <!-- Compile site JavaScript. -->

    <target name="project:assets:compile:javascript" depends="project:config" description="Compile site JavaScript">
        <phingy:assets:browserify in="${build.public_dir}/app/themes/starter/assets/js/main.js" out="${build.public_dir}/app/themes/starter/assets/js/compiled.js" useLocal="true" globalTransforms="browserify-shim" />
        <phingy:assets:uglifyjs in="${build.public_dir}/app/themes/starter/assets/js/compiled.js" out="${build.public_dir}/app/themes/starter/assets/js/compiled.js" useLocal="true" />
    </target>


    <!-- Watch site JavaScript for changes. -->

    <target name="project:assets:watch:javascript" depends="project:config" description="Watch site JavaScript for changes">
        <phingy:assets:watchify watch="${build.public_dir}/app/themes/starter/assets/js/main.js" out="${build.public_dir}/app/themes/starter/assets/js/compiled.js" useLocal="true" globalTransforms="browserify-shim" />
    </target>


</project>
